<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德州扑克买入结算工具</title>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .bg-\[\#f5f7fb\] { background-color: #f5f7fb; }
        .min-h-screen { min-height: 100vh; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { --tw-space-y-reverse: 0; margin-top: calc(1.5rem * calc(1 - var(--tw-space-y-reverse))); margin-bottom: calc(1.5rem * var(--tw-space-y-reverse)); }
        .p-4 { padding: 1rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .bg-white { background-color: #ffffff; }
        .rounded-2xl { border-radius: 1rem; }
        .shadow { --tw-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow); }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .border { border-width: 1px; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .bg-sky-50 { background-color: #f0f9ff; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:ring:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-sky-200:focus { --tw-ring-color: #e0f2fe; }
        .bg-emerald-50 { background-color: #ecfdf5; }
        .focus\:ring-emerald-200:focus { --tw-ring-color: #a7f3d0; }
        .bg-purple-50 { background-color: #faf5ff; }
        .focus\:ring-purple-200:focus { --tw-ring-color: #e9d5ff; }
        .md\:col-span-2 { grid-column: span 2 / span 2; }
        .flex-1 { flex: 1 1 0%; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .focus\:ring-indigo-200:focus { --tw-ring-color: #c7d2fe; }
        .rounded-2xl { border-radius: 1rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .text-white { color: #ffffff; }
        .shadow { --tw-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow); }
        .mt-2 { margin-top: 0.5rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-gray-600 { color: #4b5563; }
        .inline-flex { display: inline-flex; }
        .gap-2 { gap: 0.5rem; }
        .overflow-x-auto { overflow-x: auto; }
        .min-w-full { min-width: 100%; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-gray-600 { color: #4b5563; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .text-left { text-align: left; }
        .border-t { border-top-width: 1px; }
        .align-top { vertical-align: top; }
        .font-medium { font-weight: 500; }
        .mt-1 { margin-top: 0.25rem; }
        .text-gray-500 { color: #6b7280; }
        .break-words { overflow-wrap: break-word; }
        .flex-wrap { flex-wrap: wrap; }
        .bg-cyan-600 { background-color: #0891b2; }
        .hover\:bg-cyan-700:hover { background-color: #0e7490; }
        .rounded-2xl { border-radius: 1rem; }
        .text-white { color: #ffffff; }
        .bg-blue-50 { background-color: #eff6ff; }
        .focus\:ring-blue-200:focus { --tw-ring-color: #bfdbfe; }
        .w-28 { width: 7rem; }
        .bg-yellow-50 { background-color: #fffbeb; }
        .focus\:ring-yellow-200:focus { --tw-ring-color: #fef08a; }
        .gap-1 { gap: 0.25rem; }
        .text-gray-700 { color: #374151; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .bg-emerald-50 { background-color: #ecfdf5; }
        .flex-col { flex-direction: column; }
        .items-start { align-items: flex-start; }
        .bg-purple-600 { background-color: #9333ea; }
        .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .hover\:bg-purple-200:hover { background-color: #e9d5ff; }
        .leading-6 { line-height: 1.5rem; }
        .text-green-600 { color: #16a34a; }
        .text-red-600 { color: #dc2626; }
        .bg-rose-600 { background-color: #e11d48; }
        .hover\:bg-rose-700:hover { background-color: #be123c; }
        .bg-gray-300 { background-color: #d1d5db; }
        .cursor-not-allowed { cursor: not-allowed; }
        .space-y-1 > :not([hidden]) ~ :not([hidden]) { --tw-space-y-reverse: 0; margin-top: calc(0.25rem * calc(1 - var(--tw-space-y-reverse))); margin-bottom: calc(0.25rem * var(--tw-space-y-reverse)); }
        .text-amber-700 { color: #b45309; }
        .bg-amber-600 { background-color: #d97706; }
        .hover\:bg-amber-700:hover { background-color: #b45309; }
        .font-semibold { font-weight: 600; }
        .bg-orange-50 { background-color: #fff7ed; }
        .focus\:ring-orange-200:focus { --tw-ring-color: #fed7aa; }
        .no-spinner::-webkit-outer-spin-button, .no-spinner::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinner { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const R = React, RD = ReactDOM;
        const initialNames = ["Jim", "li yuelin", "Jack", "Ying qi", "Annmary", "Bo", "Sue", "he", "Emma", "Sun", "Alex", "Tony", "ke", "Dudu", "Jasonma"];
        const DiscountOptions = [{ key: "none", label: "不打折", factor: 1 }, { key: "half", label: "除2", factor: 0.5 }, { key: "third", label: "除3", factor: 1 / 3 }];
        const round5up = (v) => Math.ceil(v / 5) * 5;
        const currency = (n) => { const v = Number(n) || 0; return (Math.round(v * 100) / 100).toFixed(2); };
        const clampMinZero = (n) => Math.max(0, Number(n) || 0);
        function tierTaxByWin(win) {
          const w = Number(win) || 0;
          if (w < 50) return 0;
          if (w < 75) return 5;
          const blocks = Math.floor((w - 75) / 50);
          return 10 + 5 * blocks;
        }
        function computeAll(players, globalDiscountKey, starFee, memberFee, acceptedDiffRaw, preFeaturePayoutRaw) {
          const factor = (DiscountOptions.find((d) => d.key === globalDiscountKey) || { factor: 1 }).factor;
          const totalBuyRaw = players.reduce((a, p) => a + (p.buys || []).reduce((x, y) => x + y, 0), 0);
          const totalPayoutRaw = players.reduce((a, p) => a + (p.includePayout ? (Number(p.payoutStr) || 0) : 0), 0);
          const trialBalanceExtraRaw = Number(preFeaturePayoutRaw) || 0;
          const trialBalanceRaw = totalBuyRaw - totalPayoutRaw - trialBalanceExtraRaw;
          const trialBalanceVisible = trialBalanceRaw - (acceptedDiffRaw || 0);
          let totalDeltaDiscounted = 0;
          let totalDeltaRounded = 0;
          let totalRoundingOverflow = 0;
          let totalTaxPlayers = 0;
          const rows = players.map((p) => {
            const rawBuy = (p.buys || []).reduce((s, v) => s + v, 0);
            const star = p.stargazer ? Number(starFee) || 0 : 0;
            const payout = p.includePayout ? (Number(p.payoutStr) || 0) : 0;
            const discountedDelta = (payout - rawBuy - star) * factor;
            const lossForRelief = Math.max(0, -discountedDelta);
            const roundedDelta = round5up(discountedDelta);
            const roundingOverflow = roundedDelta - discountedDelta;
            const memberBase = (Number(p.memberCount || 0) || 0) * (Number(memberFee) || 0);
            let memberAfterRelief = memberBase;
            if ((p.memberCount || 0) >= 2) {
              if (lossForRelief >= 300) memberAfterRelief = memberBase * 0.5;
              else if (lossForRelief >= 200) memberAfterRelief = clampMinZero(memberBase - 10);
            }
            let net = roundedDelta - memberAfterRelief;
            let tax = tierTaxByWin(net);
            if ((p.memberCount || 0) >= 2) {
              if (tax >= 40) tax = clampMinZero(tax - 20);
              else if (tax >= 20) tax = clampMinZero(tax - 10);
            }
            totalDeltaDiscounted += discountedDelta;
            totalDeltaRounded += roundedDelta;
            totalRoundingOverflow += roundingOverflow;
            if (tax > 0) totalTaxPlayers += tax;
            return {
              id: p.id,
              name: p.name,
              buys: p.buys,
              payoutStr: p.payoutStr,
              includePayout: p.includePayout,
              stargazer: p.stargazer,
              memberCount: p.memberCount,
              rawBuy,
              star,
              discountedDelta,
              roundedDelta,
              roundingOverflow,
              memberBase,
              memberAfterRelief,
              lossForRelief,
              net,
              tax,
            };
          });
          return {
            factor,
            rows,
            totalBuyRaw,
            totalPayoutRaw,
            trialBalanceRaw,
            trialBalanceVisible,
            totalDeltaDiscounted,
            totalDeltaRounded,
            totalRoundingOverflow,
            totalTaxPlayers,
            trialBalanceExtraRaw,
          };
        }
        function App() {
          const [speakOn, setSpeakOn] = R.useState(true);
          const [speakRate, setSpeakRate] = R.useState(1.0);
          const speakLock = R.useRef(false);
          function speak(text) {
            try {
              if (!speakOn || typeof window === "undefined" || !window.speechSynthesis) return;
              if (speakLock.current) return;
              speakLock.current = true;
              const u = new SpeechSynthesisUtterance(text);
              u.rate = speakRate;
              u.lang = "zh-CN";
              u.onend = () => {
                speakLock.current = false;
              };
              window.speechSynthesis.speak(u);
            } catch {}
          }
          const [globalDiscountKey, setGlobalDiscountKey] = R.useState("none");
          const [starFee, setStarFee] = R.useState(20);
          const [memberFee, setMemberFee] = R.useState(20);
          const [starFeeDraft, setStarFeeDraft] = R.useState("20");
          const [memberFeeDraft, setMemberFeeDraft] = R.useState("20");
          const [payoutDraft, setPayoutDraft] = R.useState({});
          const [newPlayerNameDraft, setNewPlayerNameDraft] = R.useState("");
          const [acceptedDiffRaw, setAcceptedDiffRaw] = R.useState(0);
          const [acceptedTaxFromDiff, setAcceptedTaxFromDiff] = R.useState(0);
          const [preFeaturePayoutRaw, setPreFeaturePayoutRaw] = R.useState(0);
          const [players, setPlayers] = R.useState(() => initialNames.map((name, idx) => ({ id: `${idx + 1}`, name, buys: [], payoutStr: "", includePayout: false, stargazer: false, memberCount: 0 })));
          function addPlayer() {
            const name = newPlayerNameDraft.trim();
            if (!name) return;
            setPlayers((prev) => [...prev, {
              id: `${Date.now()}`,
              name,
              buys: [],
              payoutStr: "",
              includePayout: false,
              stargazer: false,
              memberCount: 0,
            }, ]);
            setNewPlayerNameDraft("");
          }
          function removePlayer(id) {
            setPlayers((prev) => prev.filter((p) => p.id !== id));
          }
          function updatePlayer(id, updater) {
            setPlayers((prev) => prev.map((p) => (p
